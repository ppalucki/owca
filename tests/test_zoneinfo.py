# Copyright (c) 2020 Intel Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
import re
from unittest.mock import patch

from tests.testing import create_open_mock, relative_module_path
from wca.metrics import MetricName
from wca.zoneinfo import get_zoneinfo_measurements, DEFAULT_REGEXP


@patch('builtins.open', new=create_open_mock({
    "/proc/zoneinfo": open(relative_module_path(__file__, 'fixtures/proc-zoneinfo.txt')).read(),
}))
def test_parse_proc_zoneinfo(*mocks):
    assert get_zoneinfo_measurements(re.compile(DEFAULT_REGEXP)) == {
        MetricName.PLATFORM_ZONEINFO: {'0': {'DMA': {'high': 6.0,
                                                     'hmem_autonuma_promote_dst': 0.0,
                                                     'hmem_autonuma_promote_src': 0.0,
                                                     'hmem_reclaim_demote_dst': 0.0,
                                                     'hmem_reclaim_demote_src': 0.0,
                                                     'hmem_reclaim_promote_dst': 0.0,
                                                     'hmem_reclaim_promote_src': 0.0,
                                                     'hmem_swapcache_promote_dst': 0.0,
                                                     'hmem_swapcache_promote_src': 0.0,
                                                     'hmem_unknown': 0.0,
                                                     'low': 3.0,
                                                     'managed': 3840.0,
                                                     'min': 0.0,
                                                     'nr_accessed': 16376974.0,
                                                     'nr_active_anon': 103276.0,
                                                     'nr_active_file': 69737.0,
                                                     'nr_anon_pages': 111769.0,
                                                     'nr_anon_transparent_hugepages': 0.0,
                                                     'nr_bounce': 0.0,
                                                     'nr_dirtied': 589399.0,
                                                     'nr_dirty': 27.0,
                                                     'nr_file_hugepages': 0.0,
                                                     'nr_file_pages': 115067.0,
                                                     'nr_file_pmdmapped': 0.0,
                                                     'nr_free_cma': 0.0,
                                                     'nr_free_pages': 3840.0,
                                                     'nr_inactive_anon': 2071.0,
                                                     'nr_inactive_file': 51401.0,
                                                     'nr_isolated_anon': 0.0,
                                                     'nr_isolated_file': 0.0,
                                                     'nr_kernel_misc_reclaimable': 0.0,
                                                     'nr_kernel_stack': 0.0,
                                                     'nr_mapped': 38282.0,
                                                     'nr_mlock': 0.0,
                                                     'nr_page_table_pages': 0.0,
                                                     'nr_promote_fail': 0.0,
                                                     'nr_promote_isolate_fail': 0.0,
                                                     'nr_promote_ratelimit': 0.0,
                                                     'nr_promoted': 0.0,
                                                     'nr_shmem': 531.0,
                                                     'nr_shmem_hugepages': 0.0,
                                                     'nr_shmem_pmdmapped': 0.0,
                                                     'nr_slab_reclaimable': 26118.0,
                                                     'nr_slab_unreclaimable': 81166.0,
                                                     'nr_unevictable': 0.0,
                                                     'nr_unstable': 0.0,
                                                     'nr_vmscan_immediate_reclaim': 0.0,
                                                     'nr_vmscan_write': 0.0,
                                                     'nr_writeback': 0.0,
                                                     'nr_writeback_temp': 0.0,
                                                     'nr_written': 26245.0,
                                                     'nr_zone_active_anon': 0.0,
                                                     'nr_zone_active_file': 0.0,
                                                     'nr_zone_inactive_anon': 0.0,
                                                     'nr_zone_inactive_file': 0.0,
                                                     'nr_zone_unevictable': 0.0,
                                                     'nr_zone_write_pending': 0.0,
                                                     'nr_zspages': 0.0,
                                                     'numa_foreign': 0.0,
                                                     'numa_hit': 0.0,
                                                     'numa_interleave': 0.0,
                                                     'numa_local': 0.0,
                                                     'numa_miss': 0.0,
                                                     'numa_other': 0.0,
                                                     'numa_try_migrate': 0.0,
                                                     'present': 3992.0,
                                                     'spanned': 4095.0,
                                                     'workingset_activate': 0.0,
                                                     'workingset_nodereclaim': 0.0,
                                                     'workingset_nodes': 0.0,
                                                     'workingset_refault': 0.0,
                                                     'workingset_restore': 0.0},
                                             'DMA32': {'high': 861.0,
                                                       'hmem_autonuma_promote_dst': 0.0,
                                                       'hmem_autonuma_promote_src': 0.0,
                                                       'hmem_reclaim_demote_dst': 0.0,
                                                       'hmem_reclaim_demote_src': 0.0,
                                                       'hmem_reclaim_promote_dst': 0.0,
                                                       'hmem_reclaim_promote_src': 0.0,
                                                       'hmem_swapcache_promote_dst': 0.0,
                                                       'hmem_swapcache_promote_src': 0.0,
                                                       'hmem_unknown': 0.0,
                                                       'low': 437.0,
                                                       'managed': 424697.0,
                                                       'min': 13.0,
                                                       'nr_bounce': 0.0,
                                                       'nr_free_cma': 0.0,
                                                       'nr_free_pages': 424303.0,
                                                       'nr_kernel_stack': 0.0,
                                                       'nr_mlock': 0.0,
                                                       'nr_page_table_pages': 0.0,
                                                       'nr_zone_active_anon': 0.0,
                                                       'nr_zone_active_file': 0.0,
                                                       'nr_zone_inactive_anon': 0.0,
                                                       'nr_zone_inactive_file': 0.0,
                                                       'nr_zone_unevictable': 0.0,
                                                       'nr_zone_write_pending': 0.0,
                                                       'nr_zspages': 0.0,
                                                       'numa_foreign': 0.0,
                                                       'numa_hit': 1.0,
                                                       'numa_interleave': 0.0,
                                                       'numa_local': 1.0,
                                                       'numa_miss': 0.0,
                                                       'numa_other': 0.0,
                                                       'present': 441081.0,
                                                       'spanned': 1044480.0},
                                             'Normal': {'high': 0.0,
                                                        'hmem_autonuma_promote_dst': 2151.0,
                                                        'hmem_autonuma_promote_src': 0.0,
                                                        'hmem_reclaim_demote_dst': 0.0,
                                                        'hmem_reclaim_demote_src': 0.0,
                                                        'hmem_reclaim_promote_dst': 0.0,
                                                        'hmem_reclaim_promote_src': 0.0,
                                                        'hmem_swapcache_promote_dst': 0.0,
                                                        'hmem_swapcache_promote_src': 0.0,
                                                        'hmem_unknown': 0.0,
                                                        'low': 0.0,
                                                        'managed': 0.0,
                                                        'min': 0.0,
                                                        'nr_bounce': 0.0,
                                                        'nr_free_cma': 0.0,
                                                        'nr_free_pages': 44816301.0,
                                                        'nr_kernel_stack': 11896.0,
                                                        'nr_mlock': 0.0,
                                                        'nr_page_table_pages': 67830.0,
                                                        'nr_zone_active_anon': 103024.0,
                                                        'nr_zone_active_file': 69737.0,
                                                        'nr_zone_inactive_anon': 2071.0,
                                                        'nr_zone_inactive_file': 51401.0,
                                                        'nr_zone_unevictable': 0.0,
                                                        'nr_zone_write_pending': 27.0,
                                                        'nr_zspages': 0.0,
                                                        'numa_foreign': 0.0,
                                                        'numa_hit': 27514862304.0,
                                                        'numa_interleave': 36755.0,
                                                        'numa_local': 27514857506.0,
                                                        'numa_miss': 1532135.0,
                                                        'numa_other': 1536941.0,
                                                        'present': 0.0,
                                                        'spanned': 218103808.0}},
                                       '1': {'DMA': {'high': 0.0,
                                                     'low': 0.0,
                                                     'managed': 0.0,
                                                     'min': 0.0,
                                                     'present': 0.0,
                                                     'spanned': 0.0},
                                             'DMA32': {'high': 0.0,
                                                       'low': 0.0,
                                                       'managed': 0.0,
                                                       'min': 0.0,
                                                       'present': 0.0,
                                                       'spanned': 0.0},
                                             'Normal': {'high': 0.0,
                                                        'hmem_autonuma_promote_dst': 120221148.0,
                                                        'hmem_autonuma_promote_src': 0.0,
                                                        'hmem_reclaim_demote_dst': 0.0,
                                                        'hmem_reclaim_demote_src': 122231089.0,
                                                        'hmem_reclaim_promote_dst': 149.0,
                                                        'hmem_reclaim_promote_src': 0.0,
                                                        'hmem_swapcache_promote_dst': 0.0,
                                                        'hmem_swapcache_promote_src': 0.0,
                                                        'hmem_unknown': 0.0,
                                                        'low': 0.0,
                                                        'managed': 0.0,
                                                        'min': 0.0,
                                                        'nr_accessed': 595514.0,
                                                        'nr_active_anon': 44764263.0,
                                                        'nr_active_file': 84.0,
                                                        'nr_anon_pages': 45864007.0,
                                                        'nr_anon_transparent_hugepages': 0.0,
                                                        'nr_bounce': 0.0,
                                                        'nr_dirtied': 7849.0,
                                                        'nr_dirty': 6.0,
                                                        'nr_file_hugepages': 0.0,
                                                        'nr_file_pages': 66.0,
                                                        'nr_file_pmdmapped': 0.0,
                                                        'nr_free_cma': 0.0,
                                                        'nr_free_pages': 99683.0,
                                                        'nr_inactive_anon': 1099415.0,
                                                        'nr_inactive_file': 52.0,
                                                        'nr_isolated_anon': 0.0,
                                                        'nr_isolated_file': 0.0,
                                                        'nr_kernel_misc_reclaimable': 0.0,
                                                        'nr_kernel_stack': 9256.0,
                                                        'nr_mapped': 34.0,
                                                        'nr_mlock': 0.0,
                                                        'nr_page_table_pages': 90638.0,
                                                        'nr_promote_fail': 0.0,
                                                        'nr_promote_isolate_fail': 0.0,
                                                        'nr_promote_ratelimit': 0.0,
                                                        'nr_promoted': 0.0,
                                                        'nr_shmem': 4.0,
                                                        'nr_shmem_hugepages': 0.0,
                                                        'nr_shmem_pmdmapped': 0.0,
                                                        'nr_slab_reclaimable': 15083.0,
                                                        'nr_slab_unreclaimable': 46869.0,
                                                        'nr_unevictable': 0.0,
                                                        'nr_unstable': 0.0,
                                                        'nr_vmscan_immediate_reclaim': 0.0,
                                                        'nr_vmscan_write': 0.0,
                                                        'nr_writeback': 0.0,
                                                        'nr_writeback_temp': 0.0,
                                                        'nr_written': 7780.0,
                                                        'nr_zone_active_anon': 44764263.0,
                                                        'nr_zone_active_file': 84.0,
                                                        'nr_zone_inactive_anon': 1099415.0,
                                                        'nr_zone_inactive_file': 52.0,
                                                        'nr_zone_unevictable': 0.0,
                                                        'nr_zone_write_pending': 6.0,
                                                        'nr_zspages': 0.0,
                                                        'numa_foreign': 66862806.0,
                                                        'numa_hit': 4253130819.0,
                                                        'numa_interleave': 36586.0,
                                                        'numa_local': 4253071940.0,
                                                        'numa_miss': 0.0,
                                                        'numa_other': 58879.0,
                                                        'numa_try_migrate': 6101781.0,
                                                        'present': 0.0,
                                                        'spanned': 218103808.0,
                                                        'workingset_activate': 0.0,
                                                        'workingset_nodereclaim': 0.0,
                                                        'workingset_nodes': 0.0,
                                                        'workingset_refault': 0.0,
                                                        'workingset_restore': 0.0}},
                                       '2': {'DMA': {'high': 0.0,
                                                     'low': 0.0,
                                                     'managed': 0.0,
                                                     'min': 0.0,
                                                     'present': 0.0,
                                                     'spanned': 0.0},
                                             'DMA32': {'high': 0.0,
                                                       'low': 0.0,
                                                       'managed': 0.0,
                                                       'min': 0.0,
                                                       'present': 0.0,
                                                       'spanned': 0.0},
                                             'Normal': {'high': 0.0,
                                                        'hmem_autonuma_promote_dst': 0.0,
                                                        'hmem_autonuma_promote_src': 0.0,
                                                        'hmem_reclaim_demote_dst': 0.0,
                                                        'hmem_reclaim_demote_src': 0.0,
                                                        'hmem_reclaim_promote_dst': 0.0,
                                                        'hmem_reclaim_promote_src': 0.0,
                                                        'hmem_swapcache_promote_dst': 0.0,
                                                        'hmem_swapcache_promote_src': 0.0,
                                                        'hmem_unknown': 0.0,
                                                        'low': 0.0,
                                                        'managed': 0.0,
                                                        'min': 0.0,
                                                        'nr_accessed': 0.0,
                                                        'nr_active_anon': 0.0,
                                                        'nr_active_file': 0.0,
                                                        'nr_anon_pages': 0.0,
                                                        'nr_anon_transparent_hugepages': 0.0,
                                                        'nr_bounce': 0.0,
                                                        'nr_dirtied': 0.0,
                                                        'nr_dirty': 0.0,
                                                        'nr_file_hugepages': 0.0,
                                                        'nr_file_pages': 0.0,
                                                        'nr_file_pmdmapped': 0.0,
                                                        'nr_free_cma': 0.0,
                                                        'nr_free_pages': 214433792.0,
                                                        'nr_inactive_anon': 0.0,
                                                        'nr_inactive_file': 0.0,
                                                        'nr_isolated_anon': 0.0,
                                                        'nr_isolated_file': 0.0,
                                                        'nr_kernel_misc_reclaimable': 0.0,
                                                        'nr_kernel_stack': 0.0,
                                                        'nr_mapped': 0.0,
                                                        'nr_mlock': 0.0,
                                                        'nr_page_table_pages': 0.0,
                                                        'nr_promote_fail': 0.0,
                                                        'nr_promote_isolate_fail': 0.0,
                                                        'nr_promote_ratelimit': 0.0,
                                                        'nr_promoted': 0.0,
                                                        'nr_shmem': 0.0,
                                                        'nr_shmem_hugepages': 0.0,
                                                        'nr_shmem_pmdmapped': 0.0,
                                                        'nr_slab_reclaimable': 0.0,
                                                        'nr_slab_unreclaimable': 0.0,
                                                        'nr_unevictable': 0.0,
                                                        'nr_unstable': 0.0,
                                                        'nr_vmscan_immediate_reclaim': 0.0,
                                                        'nr_vmscan_write': 0.0,
                                                        'nr_writeback': 0.0,
                                                        'nr_writeback_temp': 0.0,
                                                        'nr_written': 0.0,
                                                        'nr_zone_active_anon': 0.0,
                                                        'nr_zone_active_file': 0.0,
                                                        'nr_zone_inactive_anon': 0.0,
                                                        'nr_zone_inactive_file': 0.0,
                                                        'nr_zone_unevictable': 0.0,
                                                        'nr_zone_write_pending': 0.0,
                                                        'nr_zspages': 0.0,
                                                        'numa_foreign': 0.0,
                                                        'numa_hit': 0.0,
                                                        'numa_interleave': 0.0,
                                                        'numa_local': 0.0,
                                                        'numa_miss': 0.0,
                                                        'numa_other': 0.0,
                                                        'numa_try_migrate': 0.0,
                                                        'present': 0.0,
                                                        'spanned': 0.0,
                                                        'workingset_activate': 0.0,
                                                        'workingset_nodereclaim': 0.0,
                                                        'workingset_nodes': 0.0,
                                                        'workingset_refault': 0.0,
                                                        'workingset_restore': 0.0}},
                                       '3': {'DMA': {'high': 0.0,
                                                     'low': 0.0,
                                                     'managed': 0.0,
                                                     'min': 0.0,
                                                     'present': 0.0,
                                                     'spanned': 0.0},
                                             'DMA32': {'high': 0.0,
                                                       'low': 0.0,
                                                       'managed': 0.0,
                                                       'min': 0.0,
                                                       'present': 0.0,
                                                       'spanned': 0.0},
                                             'Normal': {'high': 0.0,
                                                        'hmem_autonuma_promote_dst': 0.0,
                                                        'hmem_autonuma_promote_src': 120223299.0,
                                                        'hmem_reclaim_demote_dst': 122231089.0,
                                                        'hmem_reclaim_demote_src': 0.0,
                                                        'hmem_reclaim_promote_dst': 0.0,
                                                        'hmem_reclaim_promote_src': 149.0,
                                                        'hmem_swapcache_promote_dst': 0.0,
                                                        'hmem_swapcache_promote_src': 0.0,
                                                        'hmem_unknown': 0.0,
                                                        'low': 0.0,
                                                        'managed': 0.0,
                                                        'min': 0.0,
                                                        'nr_accessed': 41233.0,
                                                        'nr_active_anon': 2335836.0,
                                                        'nr_active_file': 16.0,
                                                        'nr_anon_pages': 33467082.0,
                                                        'nr_anon_transparent_hugepages': 0.0,
                                                        'nr_bounce': 0.0,
                                                        'nr_dirtied': 23.0,
                                                        'nr_dirty': 0.0,
                                                        'nr_file_hugepages': 0.0,
                                                        'nr_file_pages': 4014.0,
                                                        'nr_file_pmdmapped': 0.0,
                                                        'nr_free_cma': 0.0,
                                                        'nr_free_pages': 180959529.0,
                                                        'nr_inactive_anon': 31133141.0,
                                                        'nr_inactive_file': 2103.0,
                                                        'nr_isolated_anon': 0.0,
                                                        'nr_isolated_file': 0.0,
                                                        'nr_kernel_misc_reclaimable': 0.0,
                                                        'nr_kernel_stack': 0.0,
                                                        'nr_mapped': 1696.0,
                                                        'nr_mlock': 0.0,
                                                        'nr_page_table_pages': 0.0,
                                                        'nr_promote_fail': 0.0,
                                                        'nr_promote_isolate_fail': 0.0,
                                                        'nr_promote_ratelimit': 0.0,
                                                        'nr_promoted': 149.0,
                                                        'nr_shmem': 2323.0,
                                                        'nr_shmem_hugepages': 0.0,
                                                        'nr_shmem_pmdmapped': 0.0,
                                                        'nr_slab_reclaimable': 0.0,
                                                        'nr_slab_unreclaimable': 0.0,
                                                        'nr_unevictable': 0.0,
                                                        'nr_unstable': 0.0,
                                                        'nr_vmscan_immediate_reclaim': 0.0,
                                                        'nr_vmscan_write': 0.0,
                                                        'nr_writeback': 0.0,
                                                        'nr_writeback_temp': 0.0,
                                                        'nr_written': 44.0,
                                                        'nr_zone_active_anon': 2335836.0,
                                                        'nr_zone_active_file': 16.0,
                                                        'nr_zone_inactive_anon': 31133141.0,
                                                        'nr_zone_inactive_file': 2103.0,
                                                        'nr_zone_unevictable': 0.0,
                                                        'nr_zone_write_pending': 0.0,
                                                        'nr_zspages': 0.0,
                                                        'numa_foreign': 0.0,
                                                        'numa_hit': 122235977.0,
                                                        'numa_interleave': 0.0,
                                                        'numa_local': 0.0,
                                                        'numa_miss': 65330671.0,
                                                        'numa_other': 187566648.0,
                                                        'numa_try_migrate': 0.0,
                                                        'present': 0.0,
                                                        'spanned': 0.0,
                                                        'workingset_activate': 0.0,
                                                        'workingset_nodereclaim': 0.0,
                                                        'workingset_nodes': 0.0,
                                                        'workingset_refault': 0.0,
                                                        'workingset_restore': 0.0}}}}
